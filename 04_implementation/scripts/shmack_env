# This environment has to be sourced by all public scripts.
# It defines paths to files which are shared among scripts.

if [ -f "./shmack_env" ] ; then
  export SCRIPTS_DIR=`pwd`
else 
  echo "Scripts must ALWAYS be executed with correct current directory, i.e. directory of 'shmack_env'"
  exit 99
fi

set -o pipefail

function run {
    "$@"
    local status=$?
    if [ $status -ne 0 ]; then
        echo "Failed to execute $*" >&2
	kill -9 $$ >> /dev/null
    fi
    return $status
}
export -f run

export SSH_KEY_LOCATION=${HOME}/.ssh/shmack-key-pair-01.pem

export TARGET_DIR=${SCRIPTS_DIR}/target

export TMP_OUTPUT_DIR=${TARGET_DIR}/tmp-output

export CURRENT_STATE_DIR=${TARGET_DIR}/current-state
export CURRENT_STATE_DIR_RELATIVE=target/current-state
export STATE_TAR_FILE=stack-state.tgz

export CURRENT_STACK_ID_FILE=${CURRENT_STATE_DIR}/StackId
export CURRENT_STACK_NAME_FILE=${CURRENT_STATE_DIR}/StackName
export CURRENT_MESOS_MASTER_DNS_FILE=${CURRENT_STATE_DIR}/MesosMasterDnsAddress
export CURRENT_PUBLIC_SLAVE_DNS_FILE=${CURRENT_STATE_DIR}/PublicSlaveDnsAddress

export CURRENT_MASTER_NODE_SSH_IP_ADDRESS_FILE=${CURRENT_STATE_DIR}/MasterNodeSshIpAddress
export CURRENT_NODE_INFO_FILE=${CURRENT_STATE_DIR}/NodeInfo.json

PATH=${SCRIPTS_DIR}:${SCRIPTS_DIR}/helpers:${PATH}
export PATH

# taken from http://rabexc.org/posts/pitfalls-of-ssh-agents
# see also http://stackoverflow.com/questions/5527068/how-do-you-use-an-identity-file-with-rsync
function setup-ssh-agent {
	ssh-add ${SSH_KEY_LOCATION} &>/dev/null
	if [ "$?" -ne 0 ]; then
	  test -r ~/.ssh-agent && \
	    eval "$(<~/.ssh-agent)" >/dev/null

	  ssh-add ${SSH_KEY_LOCATION} &>/dev/null
	  if [ "$?" -ne 0 ]; then
	    (umask 066; ssh-agent > ~/.ssh-agent)
	    eval "$(<~/.ssh-agent)" >/dev/null
            ssh-add ${SSH_KEY_LOCATION}
 	    echo "Added SSH-Key to ssh-agent."
	  fi
	fi
}
setup-ssh-agent
